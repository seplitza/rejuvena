/**
 * Offers Slider - Premium + Marathons
 * –ö—Ä–∞—Å–∏–≤—ã–π —Å–ª–∞–π–¥–µ—Ä —Å 3D flip —ç—Ñ—Ñ–µ–∫—Ç–æ–º
 */

import { useState, useEffect, useRef } from 'react';
import { useRouter } from 'next/router';
import { useAppSelector } from '@/store/hooks';
import { API_ENDPOINTS, API_URL } from '@/config/api';

interface Marathon {
  _id: string;
  title: string;
  description?: string;
  numberOfDays: number;
  cost: number;
  isPaid: boolean;
  startDate: string;
  userEnrolled?: boolean;
  userEnrollmentStatus?: 'pending' | 'active' | 'completed' | 'cancelled';
}

export default function OffersGrid() {
  const router = useRouter();
  const { user } = useAppSelector((state) => state.auth);
  const [marathons, setMarathons] = useState<Marathon[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [purchaseLoading, setPurchaseLoading] = useState<string | null>(null);
  const [currentSlide, setCurrentSlide] = useState(0);
  const [isAutoPlaying, setIsAutoPlaying] = useState(true);
  const autoPlayRef = useRef<NodeJS.Timeout>();

  useEffect(() => {
    fetchMarathons();
  }, []);

  const fetchMarathons = async () => {
    try {
      const apiUrl = process.env.NEXT_PUBLIC_API_URL || 'http://37.252.20.170:9527';
      console.log('üîç Fetching marathons from:', `${apiUrl}/api/marathons`);
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–ø–∏—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const headers: any = {};
      const token = localStorage.getItem('auth_token');
      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }
      
      const response = await fetch(`${apiUrl}/api/marathons`, { headers });
      console.log('üì° Response status:', response.status);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      
      const data = await response.json();
      console.log('üì¶ Marathons data:', data);
      
      if (data.success && data.marathons) {
        setMarathons(data.marathons);
        console.log('‚úÖ Loaded marathons:', data.marathons.length);
      } else {
        console.warn('‚ö†Ô∏è No marathons in response');
      }
    } catch (error) {
      console.error('‚ùå Failed to fetch marathons:', error);
      setError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ä–∞—Ñ–æ–Ω–æ–≤');
    } finally {
      setLoading(false);
    }
  };

  const handlePremiumPurchase = async () => {
    setPurchaseLoading('premium');
    
    try {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É');
        router.push('/auth/login');
        return;
      }

      const response = await fetch(API_ENDPOINTS.payment.create, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          amount: 990,
          description: '–ü—Ä–µ–º–∏—É–º –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ 30 –¥–Ω–µ–π',
          planType: 'premium',
          duration: 30
        })
      });

      const data = await response.json();
      if (data.success && data.payment?.paymentUrl) {
        window.location.href = data.payment.paymentUrl;
      } else {
        alert(data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞');
      }
    } catch (error) {
      console.error('Payment error:', error);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞');
    } finally {
      setPurchaseLoading(null);
    }
  };

  const handleMarathonAction = async (marathon: Marathon) => {
    // –ï—Å–ª–∏ –º–∞—Ä–∞—Ñ–æ–Ω —É–∂–µ –æ–ø–ª–∞—á–µ–Ω - –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –º–∞—Ä–∞—Ñ–æ–Ω–∞
    if (marathon.userEnrolled) {
      router.push(`/marathons/${marathon._id}`);
      return;
    }

    // –ï—Å–ª–∏ –º–∞—Ä–∞—Ñ–æ–Ω –ø–ª–∞—Ç–Ω—ã–π - —Å–æ–∑–¥–∞–µ–º –ø–ª–∞—Ç–µ–∂
    if (marathon.isPaid) {
      setPurchaseLoading(marathon._id);
      
      try {
        const token = localStorage.getItem('auth_token');
        if (!token) {
          alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É');
          router.push('/auth/login');
          return;
        }

        const response = await fetch(`${API_URL}/api/payment/create-marathon`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
          })
        });

        const data = await response.json();
        if (data.success && data.payment?.paymentUrl) {
          window.location.href = data.payment.paymentUrl;
        } else {
          alert(data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞');
        }
      } catch (error) {
        console.error('Payment error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞');
      } finally {
        setPurchaseLoading(null);
      }
    } else {
      // –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –º–∞—Ä–∞—Ñ–æ–Ω - —Å—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏–º
      router.push(`/marathons/${marathon._id}`);
    }
  };

  const getDaysText = (days: number) => {
    if (days === 0) return '–ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π –º–∞—Ä–∞—Ñ–æ–Ω';
    if (days % 10 === 1 && days % 100 !== 11) return `${days} –¥–µ–Ω—å`;
    if ([2, 3, 4].includes(days % 10) && ![12, 13, 14].includes(days % 100)) return `${days} –¥–Ω—è`;
    return `${days} –¥–Ω–µ–π`;
  };

  // Premium card data
  const premiumCard = {
    id: 'premium',
    type: 'premium',
    title: '–ü—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø',
    subtitle: '–ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º',
    badge: '‚≠ê –ü–æ–ø—É–ª—è—Ä–Ω—ã–π',
    badgeColor: 'bg-yellow-400 text-yellow-900',
    gradient: { from: '#9333ea', to: '#ec4899' },
    borderColor: 'border-purple-200 hover:border-purple-400',
    price: 990,
    priceLabel: '/ –º–µ—Å—è—Ü',
    features: [
      { title: '–ü–æ–ª–Ω–æ–µ –≤–∏–¥–µ–æ-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è', description: '–î–µ—Ç–∞–ª—å–Ω–∞—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∫–∞–∂–¥–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è' },
      { title: '–î–æ—Å—Ç—É–ø –Ω–∞ 1 –º–µ—Å—è—Ü', description: '30 –¥–Ω–µ–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞' },
      { title: '–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π', description: '100+ –≤–∏–¥–µ–æ, –ª–∏—Ü–æ, —à–µ—è, —Ç–µ–ª–æ + –¥—Ä—É–≥–æ–µ' }
    ],
    isEnrolled: false,
    enrollmentStatus: undefined
  };

  // All slides: Premium + Marathons
  const allSlides = [
    ...(user?.isPremium ? [] : [premiumCard]),
    ...marathons.filter(m => !m.userEnrolled).map(m => ({
      id: m._id,
      type: 'marathon',
      title: m.title,
      subtitle: m.description || '–ú–∞—Ä–∞—Ñ–æ–Ω –æ–º–æ–ª–æ–∂–µ–Ω–∏—è',
      badge: m.userEnrolled ? '‚úì –û–ø–ª–∞—á–µ–Ω–æ' : (!m.isPaid ? 'üéÅ –ë–µ—Å–ø–ª–∞—Ç–Ω–æ' : null),
      badgeColor: m.userEnrolled ? 'bg-green-100 text-green-800 border border-green-200' : 'bg-green-400 text-green-900',
      gradient: { from: '#2563eb', to: '#06b6d4' },
      borderColor: 'border-blue-200 hover:border-blue-400',
      price: m.isPaid ? m.cost : null,
      priceLabel: m.isPaid ? '—Ä–∞–∑–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂' : '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ',
      features: [
        { title: '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å', description: getDaysText(m.numberOfDays) },
        { 
          title: '–°—Ç–∞—Ä—Ç –º–∞—Ä–∞—Ñ–æ–Ω–∞', 
          description: new Date(m.startDate).toLocaleDateString('ru-RU', { 
            day: 'numeric', 
            month: 'long',
            year: 'numeric'
          })
        },
        { 
          title: m.numberOfDays === 0 ? '–ö–∞–∂–¥—ã–π –¥–µ–Ω—å' : '–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è',
          description: m.numberOfDays === 0 
            ? '–û–¥–∏–Ω–∞–∫–æ–≤—ã–π –Ω–∞–±–æ—Ä —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –∫–∞–∂–¥—ã–π –¥–µ–Ω—å'
            : '–ù–æ–≤—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å'
        }
      ],
      marathonData: m,
      isEnrolled: m.userEnrolled,
      enrollmentStatus: m.userEnrollmentStatus
    }))
  ];

  // Slider controls
  const nextSlide = () => {
    setCurrentSlide((prev) => (prev + 1) % allSlides.length);
  };

  const prevSlide = () => {
    setCurrentSlide((prev) => (prev - 1 + allSlides.length) % allSlides.length);
  };

  const goToSlide = (index: number) => {
    setCurrentSlide(index);
    setIsAutoPlaying(false);
  };

  // Auto-play
  useEffect(() => {
    if (isAutoPlaying && allSlides.length > 1) {
      autoPlayRef.current = setInterval(nextSlide, 5000);
    }
    return () => {
      if (autoPlayRef.current) clearInterval(autoPlayRef.current);
    };
  }, [isAutoPlaying, allSlides.length]);

  const handleCardAction = async (slide: any) => {
    if (slide.type === 'premium') {
      await handlePremiumPurchase();
    } else if (slide.marathonData) {
      await handleMarathonAction(slide.marathonData);
    }
  };

  if (loading) {
    return (
      <div className="flex flex-col justify-center items-center py-12">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mb-4"></div>
        <span className="text-gray-600 font-medium">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π...</span>
      </div>
    );
  }

  if (error) {
    return (
      <div className="bg-red-50 border border-red-200 rounded-lg p-6 mb-6 text-center">
        <p className="text-red-600 font-semibold mb-2">{error}</p>
        <p className="text-sm text-gray-600 mb-4">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É</p>
        <button 
          onClick={fetchMarathons}
          className="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
        >
          –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
        </button>
      </div>
    );
  }

  if (allSlides.length === 0) {
    return (
      <div className="bg-gray-50 border border-gray-200 rounded-lg p-6 mb-6 text-center">
        <p className="text-gray-600">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</p>
      </div>
    );
  }

  const currentCard = allSlides[currentSlide];

  return (
    <div className="mb-8">
      <style jsx global>{`
        @keyframes slideIn {
          from {
            opacity: 0;
            transform: translateX(100px) rotateY(20deg);
          }
          to {
            opacity: 1;
            transform: translateX(0) rotateY(0);
          }
        }

        @keyframes slideOut {
          from {
            opacity: 1;
            transform: translateX(0) rotateY(0);
          }
          to {
            opacity: 0;
            transform: translateX(-100px) rotateY(-20deg);
          }
        }

        .slider-card {
          animation: slideIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
          transform-style: preserve-3d;
          perspective: 1000px;
        }

        .slider-card:hover {
          transform: scale(1.02) translateY(-8px);
          box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
        }

        .card-header {
          background: linear-gradient(135deg, var(--gradient-from), var(--gradient-to));
          position: relative;
          overflow: hidden;
        }

        .card-header::after {
          content: '';
          position: absolute;
          top: -50%;
          right: -50%;
          bottom: -50%;
          left: -50%;
          background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
          transform: rotate(45deg) translate(-100%, -100%);
          transition: transform 0.6s;
        }

        .slider-card:hover .card-header::after {
          transform: rotate(45deg) translate(100%, 100%);
        }

        .pulse-badge {
          animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
          0%, 100% { transform: scale(1); }
          50% { transform: scale(1.08); box-shadow: 0 0 20px rgba(250, 204, 21, 0.5); }
        }

        .slider-button {
          transition: all 0.3s ease;
        }

        .slider-button:hover {
          transform: scale(1.1);
          background: rgba(147, 51, 234, 0.95);
        }

        .slider-button:active {
          transform: scale(0.95);
        }

        .dot {
          transition: all 0.3s ease;
        }

        .dot:hover {
          transform: scale(1.3);
        }
      `}</style>

      {/* Slider Container */}
      <div className="relative max-w-md mx-auto">
        {/* Card */}
        <div 
          key={currentSlide}
          className="slider-card bg-white rounded-2xl shadow-2xl overflow-hidden border-2 transition-all duration-300"
          style={{
            '--gradient-from': currentCard.gradient.from,
            '--gradient-to': currentCard.gradient.to
          } as any}
        >
          {/* Header */}
          <div className="card-header p-6 text-white">
            <div className="flex items-center justify-between mb-2">
              <h3 className="text-2xl font-bold">{currentCard.title}</h3>
              {currentCard.badge && (
                <span className={`pulse-badge inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${currentCard.badgeColor}`}>
                  {currentCard.badge}
                </span>
              )}
            </div>
            <p className={`${currentCard.type === 'premium' ? 'text-purple-100' : 'text-blue-100'}`}>
              {currentCard.subtitle}
            </p>
          </div>

          {/* Body */}
          <div className="p-6">
            {/* Features */}
            <div className="space-y-4 mb-6">
              {currentCard.features.map((feature: any, idx: number) => (
                <div key={idx} className="flex items-start space-x-3">
                  <div className="flex-shrink-0 w-6 h-6 bg-green-100 rounded-full flex items-center justify-center">
                    <svg className="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                    </svg>
                  </div>
                  <div className="flex-1 min-w-0">
                    <h4 className="font-semibold text-gray-900 text-sm">{feature.title}</h4>
                    <p className="text-xs text-gray-600 mt-0.5">{feature.description}</p>
                  </div>
                </div>
              ))}
            </div>

            {/* Price & CTA */}
            <div className="border-t pt-6">
              <div className="flex items-baseline justify-between mb-4">
                <div>
                  <span className="text-4xl font-bold text-gray-900">
                    {currentCard.price !== null ? `${currentCard.price} ‚ÇΩ` : '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ'}
                  </span>
                  {currentCard.price !== null && (
                    <span className="text-gray-600 ml-2 text-sm">{currentCard.priceLabel}</span>
                  )}
                </div>
              </div>

              <button
                onClick={() => handleCardAction(currentCard)}
                disabled={purchaseLoading === currentCard.id}
                className="w-full bg-gradient-to-r text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg hover:shadow-2xl"
                style={{
                  backgroundImage: `linear-gradient(to right, ${currentCard.gradient.from}, ${currentCard.gradient.to})`
                }}
              >
                {purchaseLoading === currentCard.id 
                  ? '–û–±—Ä–∞–±–æ—Ç–∫–∞...' 
                  : currentCard.type === 'marathon' && currentCard.isEnrolled
                    ? '–ü–µ—Ä–µ–π—Ç–∏ –∫ –º–∞—Ä–∞—Ñ–æ–Ω—É ‚Üí'
                    : currentCard.price !== null 
                      ? `–û–ø–ª–∞—Ç–∏—Ç—å ${currentCard.price} ‚ÇΩ` 
                      : '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ'
                }
              </button>

              {currentCard.price !== null && (
                <p className="text-xs text-gray-500 text-center mt-3">
                  –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ –ê–ª—å—Ñ–∞-–ë–∞–Ω–∫
                </p>
              )}
            </div>
          </div>
        </div>

        {/* Navigation Arrows */}
        {allSlides.length > 1 && (
          <>
            <button
              onClick={prevSlide}
              onMouseEnter={() => setIsAutoPlaying(false)}
              className="slider-button absolute top-1/2 -left-4 md:-left-6 transform -translate-y-1/2 bg-purple-600 text-white w-10 h-10 md:w-12 md:h-12 rounded-full shadow-lg flex items-center justify-center z-10 hover:bg-purple-700"
            >
              <svg className="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
              </svg>
            </button>

            <button
              onClick={nextSlide}
              onMouseEnter={() => setIsAutoPlaying(false)}
              className="slider-button absolute top-1/2 -right-4 md:-right-6 transform -translate-y-1/2 bg-purple-600 text-white w-10 h-10 md:w-12 md:h-12 rounded-full shadow-lg flex items-center justify-center z-10 hover:bg-purple-700"
            >
              <svg className="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
              </svg>
            </button>
          </>
        )}

        {/* Dots Indicator */}
        {allSlides.length > 1 && (
          <div className="flex justify-center items-center space-x-2 mt-6">
            {allSlides.map((_, index) => (
              <button
                key={index}
                onClick={() => goToSlide(index)}
                className={`dot w-2.5 h-2.5 rounded-full transition-all ${
                  index === currentSlide 
                    ? 'bg-purple-600 w-8' 
                    : 'bg-gray-300 hover:bg-gray-400'
                }`}
                aria-label={`–ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–∞–π–¥—É ${index + 1}`}
              />
            ))}
          </div>
        )}

        {/* Counter */}
        {allSlides.length > 1 && (
          <div className="text-center mt-3 text-sm text-gray-500">
            {currentSlide + 1} / {allSlides.length}
          </div>
        )}
      </div>
    </div>
  );
}
