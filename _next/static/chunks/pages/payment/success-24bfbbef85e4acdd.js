(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[638],{7486:function(e,t,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/payment/success",function(){return a(3907)}])},3907:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return m}});var s=a(5893),l=a(7294),r=a(1163),n=a(1664),i=a.n(n),o=a(9133),d=a(3031);let c=e=>["checking","processing","succeeded","failed","error"].includes(e);function m(){var e,t,a,n,m,h,x,u,p,v,j,f,b,g,y,N,w,k;let _=(0,r.useRouter)(),D=(0,o.T)(),{orderId:T}=_.query,[I,C]=(0,l.useState)("checking"),[E,L]=(0,l.useState)(null),[z,B]=(0,l.useState)(null),S=async()=>{try{let t=localStorage.getItem("auth_token");if(!t)return;let a=await fetch("".concat("https://api-rejuvena.duckdns.org","/api/auth/me"),{headers:{Authorization:"Bearer ".concat(t)}});if(a.ok){var e;let t=await a.json();D((0,d.av)({_id:t._id||t.id,firstName:(null===(e=t.email)||void 0===e?void 0:e.split("@")[0])||"User",email:t.email,role:t.role||"admin",isPremium:t.isPremium||!1,premiumEndDate:t.premiumEndDate}))}}catch(e){console.error("Failed to refresh user data:",e)}};return(0,l.useEffect)(()=>{if(!T){C("error");return}let e=async()=>{try{var e,t,a,s,l,r,n,i;let o,d;let m=localStorage.getItem("auth_token"),h="https://api-rejuvena.duckdns.org";try{if(o=await fetch("".concat(h,"/api/payment/status-public/").concat(T)),d=await o.json(),o.ok&&d.success&&d.payment){if(L(d.payment),C(c(d.payment.status)?d.payment.status:"error"),m&&"succeeded"===d.payment.status&&await S(),(null===(e=d.payment.metadata)||void 0===e?void 0:e.type)==="marathon"||(null===(t=d.payment.metadata)||void 0===t?void 0:t.planType)==="marathon")try{let e=null;if(null===(a=d.payment.metadata)||void 0===a?void 0:a.marathonId){let t=await fetch("".concat(h,"/api/marathons/").concat(d.payment.metadata.marathonId));t.ok&&(e=await t.json())}if(!e&&d&&d.payment&&(null===(s=d.payment.metadata)||void 0===s?void 0:s.marathonName)){let t=await fetch("".concat(h,"/api/marathons"));if(t.ok&&d&&d.payment&&d.payment.metadata){let a=await t.json(),s=d.payment.metadata.marathonName;s&&(e=a.find(e=>e.title===s)||null)}}e&&B(e)}catch(e){console.error("Error loading marathon:",e)}return}}catch(e){console.log("Public endpoint failed, trying authenticated endpoint:",e)}if(m)try{if(o=await fetch("".concat(h,"/api/payment/status/").concat(T),{headers:{Authorization:"Bearer ".concat(m)}}),d=await o.json(),console.log("Payment status response (auth):",d),o.ok&&d.success&&d.payment){if(L(d.payment),C(c(d.payment.status)?d.payment.status:"error"),"succeeded"===d.payment.status&&await S(),(null===(l=d.payment.metadata)||void 0===l?void 0:l.type)==="marathon"||(null===(r=d.payment.metadata)||void 0===r?void 0:r.planType)==="marathon")try{let e=null;if(null===(n=d.payment.metadata)||void 0===n?void 0:n.marathonId){let t=await fetch("".concat(h,"/api/marathons/").concat(d.payment.metadata.marathonId));t.ok&&(e=await t.json())}if(!e&&d&&d.payment&&(null===(i=d.payment.metadata)||void 0===i?void 0:i.marathonName)){let t=await fetch("".concat(h,"/api/marathons"));if(t.ok&&d&&d.payment&&d.payment.metadata){let a=await t.json(),s=d.payment.metadata.marathonName;s&&(e=a.find(e=>e.title===s)||null)}}e&&B(e)}catch(e){console.error("Error loading marathon:",e)}return}}catch(e){console.error("Authenticated endpoint also failed:",e)}console.error("Both endpoints failed - no token or invalid response"),C("error")}catch(e){console.error("Error checking payment status:",e),C("error")}};e();let t=setInterval(()=>{"checking"===I||"processing"===I?e():clearInterval(t)},3e3);return()=>clearInterval(t)},[T,I,D]),(0,s.jsx)("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 flex items-center justify-center p-4",children:(0,s.jsxs)("div",{className:"max-w-md w-full bg-white rounded-2xl shadow-2xl overflow-hidden",children:["checking"===I&&(0,s.jsxs)("div",{className:"p-8 text-center",children:[(0,s.jsx)("div",{className:"w-20 h-20 mx-auto mb-6 relative",children:(0,s.jsxs)("svg",{className:"animate-spin w-20 h-20 text-purple-600",fill:"none",viewBox:"0 0 24 24",children:[(0,s.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,s.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}),(0,s.jsx)("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Проверка статуса платежа"}),(0,s.jsx)("p",{className:"text-gray-600",children:"Пожалуйста, подождите..."})]}),"processing"===I&&(0,s.jsxs)("div",{className:"p-8 text-center",children:[(0,s.jsx)("div",{className:"w-20 h-20 mx-auto mb-6 relative",children:(0,s.jsx)("svg",{className:"animate-pulse w-20 h-20 text-blue-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})})}),(0,s.jsx)("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Обработка платежа"}),(0,s.jsx)("p",{className:"text-gray-600",children:"Ваш платеж обрабатывается. Это может занять несколько секунд."})]}),"succeeded"===I&&(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:"bg-gradient-to-r from-green-500 to-emerald-600 p-8 text-center",children:[(0,s.jsx)("div",{className:"w-20 h-20 mx-auto mb-4 bg-white rounded-full flex items-center justify-center",children:(0,s.jsx)("svg",{className:"w-12 h-12 text-green-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),(0,s.jsx)("h2",{className:"text-3xl font-bold text-white mb-2",children:"Оплата прошла успешно!"}),(0,s.jsx)("p",{className:"text-green-100",children:"Премиум доступ активирован"})]}),(0,s.jsxs)("div",{className:"p-8",children:[E&&(0,s.jsxs)("div",{className:"mb-6 space-y-3",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center pb-3 border-b border-gray-200",children:[(0,s.jsx)("span",{className:"text-gray-600",children:"Сумма:"}),(0,s.jsxs)("span",{className:"text-2xl font-bold text-gray-900",children:[E.amount," ₽"]})]}),(0,s.jsxs)("div",{className:"flex justify-between items-center pb-3 border-b border-gray-200",children:[(0,s.jsx)("span",{className:"text-gray-600",children:"Описание:"}),(0,s.jsx)("span",{className:"text-gray-900 font-medium",children:E.description})]}),(0,s.jsxs)("div",{className:"flex justify-between items-center",children:[(0,s.jsx)("span",{className:"text-gray-600",children:"Номер заказа:"}),(0,s.jsx)("span",{className:"text-xs text-gray-500 font-mono",children:E.orderNumber})]})]}),(null==E?void 0:null===(e=E.metadata)||void 0===e?void 0:e.type)!=="marathon"&&(null==E?void 0:null===(t=E.metadata)||void 0===t?void 0:t.type)!=="exercise"&&(null==E?void 0:null===(a=E.metadata)||void 0===a?void 0:a.planType)!=="marathon"&&(null==E?void 0:null===(n=E.metadata)||void 0===n?void 0:n.planType)!=="exercise"&&(0,s.jsxs)("div",{className:"bg-purple-50 rounded-lg p-4 mb-6",children:[(0,s.jsx)("h3",{className:"font-semibold text-purple-900 mb-2",children:"✨ Теперь вам доступны:"}),(0,s.jsxs)("ul",{className:"space-y-2 text-sm text-purple-800",children:[(0,s.jsxs)("li",{className:"flex items-start",children:[(0,s.jsx)("span",{className:"mr-2",children:"✓"}),(0,s.jsx)("span",{children:"Полные фото и видео-инструкции"})]}),(0,s.jsxs)("li",{className:"flex items-start",children:[(0,s.jsx)("span",{className:"mr-2",children:"✓"}),(0,s.jsx)("span",{children:"Детальное описание техник"})]}),(0,s.jsxs)("li",{className:"flex items-start",children:[(0,s.jsx)("span",{className:"mr-2",children:"✓"}),(0,s.jsxs)("span",{children:["Доступ на ",((null==E?void 0:null===(m=E.metadata)||void 0===m?void 0:m.duration)||30)+30," дней"]})]}),(0,s.jsxs)("li",{className:"flex items-start",children:[(0,s.jsx)("span",{className:"mr-2",children:"✓"}),(0,s.jsx)("span",{children:"Фотодневник на 90 дней"})]})]})]}),((null==E?void 0:null===(h=E.metadata)||void 0===h?void 0:h.type)==="marathon"||(null==E?void 0:null===(x=E.metadata)||void 0===x?void 0:x.planType)==="marathon")&&(0,s.jsxs)("div",{className:"bg-green-50 rounded-lg p-4 mb-6",children:[(0,s.jsxs)("h3",{className:"font-semibold text-green-900 mb-2",children:['\uD83C\uDFAF Марафон "',null==E?void 0:null===(u=E.metadata)||void 0===u?void 0:u.marathonName,'"']}),(0,s.jsxs)("ul",{className:"space-y-2 text-sm text-green-800",children:[(0,s.jsxs)("li",{className:"flex items-start",children:[(0,s.jsx)("span",{className:"mr-2",children:"✓"}),(0,s.jsxs)("span",{children:["Доступ на ",(null==E?void 0:null===(p=E.metadata)||void 0===p?void 0:p.marathonTenure)||44," дней"]})]}),(0,s.jsxs)("li",{className:"flex items-start",children:[(0,s.jsx)("span",{className:"mr-2",children:"✓"}),(0,s.jsx)("span",{children:"Ежедневные упражнения и задания"})]}),(0,s.jsxs)("li",{className:"flex items-start",children:[(0,s.jsx)("span",{className:"mr-2",children:"✓"}),(0,s.jsx)("span",{children:"Фотодневник на 90 дней"})]}),(0,s.jsxs)("li",{className:"flex items-start",children:[(0,s.jsx)("span",{className:"mr-2",children:"✓"}),(0,s.jsx)("span",{children:"Персональный трекинг прогресса"})]})]})]}),(0,s.jsx)(i(),{href:((null==E?void 0:null===(v=E.metadata)||void 0===v?void 0:v.type)==="marathon"||(null==E?void 0:null===(j=E.metadata)||void 0===j?void 0:j.planType)==="marathon")&&(null==E?void 0:null===(f=E.metadata)||void 0===f?void 0:f.marathonId)?"/marathons/".concat(E.metadata.marathonId,"/start"):"/exercises",className:"block w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white text-center font-semibold py-3 px-6 rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all duration-200 shadow-lg hover:shadow-xl",children:(null==E?void 0:null===(b=E.metadata)||void 0===b?void 0:b.type)==="marathon"||(null==E?void 0:null===(g=E.metadata)||void 0===g?void 0:g.planType)==="marathon"?"Перейти в марафон":"Перейти к упражнениям"}),((null==E?void 0:null===(y=E.metadata)||void 0===y?void 0:y.type)==="marathon"||(null==E?void 0:null===(N=E.metadata)||void 0===N?void 0:N.planType)==="marathon")&&(null==z?void 0:z.telegramGroupUrl)&&(0,s.jsx)("div",{className:"mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200",children:(0,s.jsxs)("div",{className:"flex items-start gap-3",children:[(0,s.jsx)("span",{className:"text-2xl",children:"\uD83D\uDCF1"}),(0,s.jsxs)("div",{className:"flex-1",children:[(0,s.jsx)("h3",{className:"font-semibold text-blue-900 mb-2",children:"Присоединяйтесь к группе марафона в Telegram"}),(0,s.jsx)("p",{className:"text-sm text-blue-800 mb-3",children:"Там выходят прямые эфиры с автором"}),(0,s.jsx)("a",{href:z.telegramGroupUrl,target:"_blank",rel:"noopener noreferrer",className:"inline-block bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200",children:"Открыть группу →"})]})]})}),((null==E?void 0:null===(w=E.metadata)||void 0===w?void 0:w.type)==="marathon"||(null==E?void 0:null===(k=E.metadata)||void 0===k?void 0:k.planType)==="marathon")&&(0,s.jsxs)("p",{className:"mt-3 text-center text-sm text-gray-600",children:["Детали оплаты отправлены в ",(0,s.jsx)("a",{href:"https://t.me/Seplitza_info_bot",target:"_blank",rel:"noopener noreferrer",className:"text-purple-600 hover:text-purple-700 underline",children:"https://t.me/Seplitza_info_bot"})]})]})]}),"failed"===I&&(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:"bg-gradient-to-r from-red-500 to-rose-600 p-8 text-center",children:[(0,s.jsx)("div",{className:"w-20 h-20 mx-auto mb-4 bg-white rounded-full flex items-center justify-center",children:(0,s.jsx)("svg",{className:"w-12 h-12 text-red-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),(0,s.jsx)("h2",{className:"text-3xl font-bold text-white mb-2",children:"Платеж не прошел"}),(0,s.jsx)("p",{className:"text-red-100",children:"Произошла ошибка при обработке платежа"})]}),(0,s.jsxs)("div",{className:"p-8",children:[(0,s.jsxs)("div",{className:"bg-red-50 rounded-lg p-4 mb-6",children:[(0,s.jsx)("p",{className:"text-red-800 text-sm",children:"Платеж был отклонен. Возможные причины:"}),(0,s.jsxs)("ul",{className:"mt-2 space-y-1 text-sm text-red-700",children:[(0,s.jsx)("li",{children:"• Недостаточно средств на карте"}),(0,s.jsx)("li",{children:"• Карта заблокирована или просрочена"}),(0,s.jsx)("li",{children:"• Введены неверные данные карты"})]})]}),(0,s.jsxs)("div",{className:"flex gap-3",children:[(0,s.jsx)(i(),{href:"/",className:"flex-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white text-center font-semibold py-3 px-6 rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all duration-200",children:"Попробовать снова"}),(0,s.jsx)(i(),{href:"/exercises",className:"flex-1 bg-gray-100 text-gray-700 text-center font-medium py-3 px-6 rounded-lg hover:bg-gray-200 transition-colors",children:"Вернуться"})]})]})]}),"error"===I&&(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:"bg-gradient-to-r from-orange-500 to-amber-600 p-8 text-center",children:[(0,s.jsx)("div",{className:"w-20 h-20 mx-auto mb-4 bg-white rounded-full flex items-center justify-center",children:(0,s.jsx)("svg",{className:"w-12 h-12 text-orange-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})})}),(0,s.jsx)("h2",{className:"text-3xl font-bold text-white mb-2",children:"Ошибка"}),(0,s.jsx)("p",{className:"text-orange-100",children:"Не удалось проверить статус платежа"})]}),(0,s.jsxs)("div",{className:"p-8",children:[localStorage.getItem("auth_token")?(0,s.jsx)("p",{className:"text-gray-600 mb-6 text-center",children:"Пожалуйста, проверьте историю платежей в личном кабинете или обратитесь в поддержку."}):(0,s.jsxs)("div",{className:"mb-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200",children:[(0,s.jsx)("h3",{className:"font-semibold text-yellow-900 mb-2",children:"\uD83D\uDD10 Требуется авторизация"}),(0,s.jsx)("p",{className:"text-sm text-yellow-800 mb-3",children:"Для проверки статуса платежа необходимо войти в аккаунт."}),(0,s.jsx)(i(),{href:"/auth/login?redirect=/payment/success?orderId=".concat(T),className:"inline-block bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200",children:"Войти в аккаунт →"})]}),(0,s.jsxs)("div",{className:"mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200",children:[(0,s.jsx)("h3",{className:"font-semibold text-blue-900 mb-2",children:"\uD83D\uDCDE Техническая поддержка"}),(0,s.jsx)("p",{className:"text-sm text-blue-800 mb-3",children:"Если возникли проблемы с приложением, обратитесь в поддержку:"}),(0,s.jsx)("a",{href:"https://t.me/seplitza_support",target:"_blank",rel:"noopener noreferrer",className:"inline-block bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200",children:"Открыть поддержку →"})]}),(0,s.jsx)(i(),{href:"/",className:"block w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white text-center font-semibold py-3 px-6 rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all duration-200",children:"Вернуться на главную"})]})]})]})})}}},function(e){e.O(0,[664,888,774,179],function(){return e(e.s=7486)}),_N_E=e.O()}]);